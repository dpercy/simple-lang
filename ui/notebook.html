
<link rel="stylesheet"
      href="vendor/codemirror.css">
<style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
  }
  body > .CodeMirror,
  body > #output {
    width: 50%;
    height: 100%;
    margin: 0;
  }

  #toolbar {
    position: fixed;
    width: 100%;
    bottom: 0;
    z-index: 999;
    background: lightgray;
  }
  
</style>


<textarea id="myTextarea">

(struct Zero 0)
(struct Succ 1)

(def one (Succ (Zero)))
(def two (Succ one))

one
(Succ one)
(Zero)

(def (plus x y)
  (match x
    [(Zero) y]
    [(Succ xx) (Succ (plus xx y))]))

(def four (plus two two))

</textarea>
<pre id="output">
</pre>
<aside id="toolbar">
  <button id="save" draggable="true">save</button>
</aside>




<script src="vendor/codemirror.js"></script>
<script>
  var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true
  });

  var connection = new WebSocket('ws://localhost:8001');
  connection.onopen = function(ev) {
    update();
  };
  connection.onmessage = function(ev) {
    document.getElementById('output').innerText = ev.data;
  };

  function update() {
    var contents = editor.getValue();
    connection.send(contents);
  }

  // TODO debounce
  // TODO show most recent success, even when there's an error
  // TODO color output to show stale/freshness
  editor.on('change', update);


  // save
  const save = document.getElementById('save');
  save.addEventListener('dragstart', ev => {
    console.log('dragstart', ev);
    const text = editor.getValue();
    //const blob = new Blob([text])
    //const file = new File([blob], 'newfile.txt');
    //const url = URL.createObjectURL(blob);
    const url = "data:text/plain;base64," + btoa(text);

    //ev.dataTransfer.dropEffect = 'copy';
    ev.dataTransfer.setData("DownloadURL", 'text/plain:foo.txt:' + url);

    //ev.dataTransfer.files.push(file);
    
    console.log('yay url', url);
  });
  save.addEventListener('dragend', ev => {
    //debugger;
  });
  
</script>
