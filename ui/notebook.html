
<link rel="stylesheet"
      href="vendor/codemirror.css">
<style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
  }
  body > .CodeMirror,
  body > #output {
    width: 50%;
    height: calc(100% - 20px); /* subtract #toolbar height */
    margin: 0;
  }

  #output {
    background-color: #fffdea;
    font-family: Monaco, monospace;
    font-size: 14px;
    overflow: scroll;
  }


  #toolbar {
    position: fixed;
    width: 100%;
    bottom: 0;
    z-index: 999;
    background: lightgray;
    height: 20px;
  }

  .result {
    /* border: 1px solid; */
    border-radius: 3px;
    /* padding: 0.25em; */
    display: inline-block;

    /*
    max-width: calc(100vw - 50px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
     */
  }
  .result.value {
    border-color: #adbbff;
    /*background-color: #d6f5ff;*/
    background-color: white;
    color: #0000cc;
  }
  .result.error {
    /*
       Don't use red for error messages!
       It shouldn't be like a bad grade on a test.
       
       Maybe orange has fewer bad connotations.
     */ 
    border-color: #ffe9cc;
    background-color: #fff7ef;
    color: #cc6600;
  }

  #save:hover:after {
    content: " - drag this button to a Finder window";
  }


  /* position results */
  .CodeMirror-linewidget {
    overflow: visible;
  }
  .result {
    position: absolute;
    right: 0;
    bottom: 0;

    max-width: 40vw;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  .result:hover {
    max-width: 90vw;
    background-color: #ffffdd;
    white-space: pre-wrap;
    padding: 1em;
    border: 1px solid #eeeebb;
  }
  .CodeMirror-line {
    background-color: #eee;
  }

  /* custom theme */
  .CodeMirror {
    font-family: Monaco, monospace;
    font-size: 14px;
  }

  
</style>


<textarea id="myTextarea">
</textarea>
<pre id="output">
</pre>
<aside id="toolbar">
  <button id="save" draggable="true">save</button>
  <input id="filename" value="example.sl" />
</aside>




<script src="vendor/codemirror.js"></script>
<script src="vendor/scrollpastend.js"></script>
<script>
  /////import { $compile_program } from "./bootstrap/compiler.mjs";
  /////import { configureRuntime, show } from "./primitives.mjs";

  var executionWorker = null;
  
  
  // wrap a void function,
  // so that calling it will be delayed to avoid duplicate calls.
  // only the most recent arglist is passed.
  function debounce(delayMillis, func) {
    var timer = null;
    return (...args) => {
      if (timer) {
	clearTimeout(timer);
      }
      timer = setTimeout(() => { func(...args); }, delayMillis);
    };
  }

  
  var editor = CodeMirror.fromTextArea(myTextarea, {
    scrollPastEnd: true,
    lineNumbers: true
  });
  window.editor = editor;
  const filenameInput = document.getElementById('filename');

  function clearLineWidgets() {
    for (var i=0; i<editor.lineCount(); ++i) {
      const li = editor.lineInfo(i);
      for (const lw of (li.widgets || [])) {
        lw.clear();
      }
    }
  }

  editor.on('change', function() {
    const sourceText = editor.getValue();
    const worker = new Worker("./execution-worker.js");
    // worker will eventually reply with the compiled text
    worker.onmessage = function(e) {
      const output = document.getElementById('output');
      output.innerText = e.data;
      clearLineWidgets();
    };
    worker.postMessage(sourceText);
  });
  
  editor.on('change', saveInBrowser);
  filenameInput.addEventListener('change', saveInBrowser);
  function saveInBrowser() {
    const text = editor.getValue();
    localStorage.lastText = text;
    sessionStorage.lastText = text;

    const name = filenameInput.value;
    localStorage.lastName = name;
    sessionStorage.lastName = name;
  }
  function loadInBrowser() {

    // prioritize sessionStorage over localStorage
    let text, name;
    if ('lastText' in sessionStorage) {
      text = sessionStorage.lastText;
      name = sessionStorage.lastName;
    } else if ('lastText' in localStorage) {
      text = localStorage.lastText;
      name = localStorage.lastName;
    } else {
      text = '';
      name = 'example.sl';
    }

    editor.setValue(text);
    filenameInput.value = name;
  }
  loadInBrowser();


  // save
  const save = document.getElementById('save');
  save.addEventListener('dragstart', ev => {
    const text = editor.getValue();
    const url = "data:text/plain;base64," + btoa(text);
    const mimeType = 'text/plain';
    const filename = filenameInput.value;
    const weirdoDownloadURL = mimeType + ':' + filename + ':' + url;
    ev.dataTransfer.setData("DownloadURL", weirdoDownloadURL);
  });
  document.addEventListener('drop', ev => {
    ev.preventDefault();
    
    if (ev.dataTransfer.files.length > 0) {
      const file = ev.dataTransfer.files[0];

      const reader = new FileReader();
      reader.addEventListener('loadend', ev => {
	const text = ev.srcElement.result;
	filenameInput.value = file.name;
	editor.setValue(text);
      });
      reader.readAsText(file);
    }
  });
  
</script>
