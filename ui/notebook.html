
<link rel="stylesheet"
      href="vendor/codemirror.css">
<style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
  }
  body > .CodeMirror,
  body > #output {
    width: 50%;
    height: 100%;
    margin: 0;
  }

  #toolbar {
    position: fixed;
    width: 100%;
    bottom: 0;
    z-index: 999;
    background: lightgray;
  }
  
</style>


<textarea id="myTextarea">
</textarea>
<pre id="output">
</pre>
<aside id="toolbar">
  <button id="save" draggable="true">save</button>
  <input id="filename" value="example.sl" />
</aside>




<script src="vendor/codemirror.js"></script>
<script>
  var editor = CodeMirror.fromTextArea(myTextarea, {
    lineNumbers: true
  });
  const filenameInput = document.getElementById('filename');

  var connection = new WebSocket('ws://localhost:8001');
  connection.onopen = function(ev) {
    function update() {
      var contents = editor.getValue();
      connection.send(contents);
    }

    // TODO debounce
    // TODO show most recent success, even when there's an error
    // TODO color output to show stale/freshness
    editor.on('change', update);
    update();
  };
  connection.onmessage = function(ev) {
    document.getElementById('output').innerText = ev.data;
  };

  // TODO debounce
  editor.on('change', saveInBrowser);
  filenameInput.addEventListener('change', saveInBrowser);
  function saveInBrowser() {
    const text = editor.getValue();
    localStorage.lastText = text;
    sessionStorage.lastText = text;

    const name = filenameInput.value;
    localStorage.lastName = name;
    sessionStorage.lastName = name;
  }
  function loadInBrowser() {

    // prioritize sessionStorage over localStorage
    let text, name;
    if ('lastText' in sessionStorage) {
      text = sessionStorage.lastText;
      name = sessionStorage.lastName;
    } else if ('lastText' in localStorage) {
      text = localStorage.lastText;
      name = localStorage.lastName;
    } else {
      text = '';
      name = 'example.sl';
    }

    editor.setValue(text);
    filenameInput.value = name;
  }
  loadInBrowser();


  // save
  const save = document.getElementById('save');
  save.addEventListener('dragstart', ev => {
    const text = editor.getValue();
    const url = "data:text/plain;base64," + btoa(text);
    const mimeType = 'text/plain';
    const filename = filenameInput.value;
    const weirdoDownloadURL = mimeType + ':' + filename + ':' + url;
    ev.dataTransfer.setData("DownloadURL", weirdoDownloadURL);
  });
  document.addEventListener('drop', ev => {
    ev.preventDefault();
    
    if (ev.dataTransfer.files.length > 0) {
      const file = ev.dataTransfer.files[0];

      const reader = new FileReader();
      reader.addEventListener('loadend', ev => {
	const text = ev.srcElement.result;
	editor.setValue(text);
      });
      reader.readAsText(file);
    }
  });
  
</script>
