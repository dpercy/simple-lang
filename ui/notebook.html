
<link rel="stylesheet"
      href="vendor/codemirror.css">
<style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: row;
  }
  body > .CodeMirror {
    width: 100%;
    height: calc(100% - 20px); /* subtract #toolbar height */
    margin: 0;
  }

  #toolbar {
    position: fixed;
    width: 100%;
    bottom: 0;
    z-index: 999;
    background: lightgray;
    height: 20px;
  }

  .result {
    border: 1px solid;
    border-radius: 3px;
    padding: 0.25em;
    display: inline-block;

    /*
    max-width: calc(100vw - 50px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    */
  }
  .result.value {
    border-color: #adbbff;
    background-color: #d6f5ff;
    color: #0000cc;
  }
  .result.error {
    border-color: #ffcccc;
    background-color: #ffefef;
    color: #cc0000;
  }

  #save:hover:after {
    content: " - drag this button to a Finder window";
  }
  
</style>


<textarea id="myTextarea">
</textarea>
<aside id="toolbar">
  <button id="save" draggable="true">save</button>
  <input id="filename" value="example.sl" />
</aside>




<script src="vendor/codemirror.js"></script>
<script src="vendor/scrollpastend.js"></script>
<script>
  var editor = CodeMirror.fromTextArea(myTextarea, {
    scrollPastEnd: true,
    lineNumbers: true
  });
  const filenameInput = document.getElementById('filename');

  var connection = new WebSocket('ws://localhost:8001');
  connection.onopen = function(ev) {
    function update() {
      var contents = editor.getValue();
      connection.send(contents);
    }

    // TODO show most recent success, even when there's an error
    editor.on('change', update);
    update();
  };
  connection.onmessage = function(ev) {
    const text = ev.data;
    const json = JSON.parse(text);

    editor.operation(() => {
      for (const lw of lineWidgets) {
	lw.clear();
      }
      lineWidgets = [];
      for (const result of json) {
	if (typeof result.endline === 'number') {
	  const lw = editor.addLineWidget(result.endline - 1, createResultWidget(result));
	  lineWidgets.push(lw);
	}
      }
    });
  };
  var lineWidgets = [];

  function createResultWidget(result) {
    const elem = document.createElement('div');
    if (result.valueText) {
      elem.classList = 'result value';
      elem.innerText = result.valueText;
    } else if (result.errorText) {
      elem.classList = 'result error';
      elem.innerText = result.errorText;
    }
    return elem;
  }

  // TODO debounce
  editor.on('change', saveInBrowser);
  filenameInput.addEventListener('change', saveInBrowser);
  function saveInBrowser() {
    const text = editor.getValue();
    localStorage.lastText = text;
    sessionStorage.lastText = text;

    const name = filenameInput.value;
    localStorage.lastName = name;
    sessionStorage.lastName = name;
  }
  function loadInBrowser() {

    // prioritize sessionStorage over localStorage
    let text, name;
    if ('lastText' in sessionStorage) {
      text = sessionStorage.lastText;
      name = sessionStorage.lastName;
    } else if ('lastText' in localStorage) {
      text = localStorage.lastText;
      name = localStorage.lastName;
    } else {
      text = '';
      name = 'example.sl';
    }

    editor.setValue(text);
    filenameInput.value = name;
  }
  loadInBrowser();


  // save
  const save = document.getElementById('save');
  save.addEventListener('dragstart', ev => {
    const text = editor.getValue();
    const url = "data:text/plain;base64," + btoa(text);
    const mimeType = 'text/plain';
    const filename = filenameInput.value;
    const weirdoDownloadURL = mimeType + ':' + filename + ':' + url;
    ev.dataTransfer.setData("DownloadURL", weirdoDownloadURL);
  });
  document.addEventListener('drop', ev => {
    ev.preventDefault();
    
    if (ev.dataTransfer.files.length > 0) {
      const file = ev.dataTransfer.files[0];

      const reader = new FileReader();
      reader.addEventListener('loadend', ev => {
	const text = ev.srcElement.result;
	editor.setValue(text);
      });
      reader.readAsText(file);
    }
  });
  
</script>
